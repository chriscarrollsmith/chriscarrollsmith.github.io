---
import BaseLayout from '../../layouts/BaseLayout.astro';
import HeaderAstro from '../../components/HeaderAstro.astro';
import Footer from '../../components/Footer.tsx';
import blogData from '../../data/blogs.json';
import type { BlogPost } from '../../types/data';
import '../../components/Blog.css';
import '../../components/BlogPost.css';
import 'prismjs/themes/prism-tomorrow.css';

export async function getStaticPaths() {
  const typedBlogData = blogData as BlogPost[];
  return typedBlogData.map(post => ({
    params: { id: String(post.id) },
    props: { post }
  }));
}

const { post }: { post: BlogPost } = Astro.props;

const pageTitle = `${post.title.slice(0, 60)} | Christopher Carroll Smith`;
const pageDescription = post.excerpt.slice(0, 155) + '...';
const pageImage = post.image || '/images/Chris_landscape.jpg';
const siteURL = 'https://christophercarrollsmith.com';
const postURL = `${siteURL}/blog/${post.id}`;
const absoluteImage = pageImage.startsWith('http') ? pageImage : `${siteURL}/${pageImage}`;

// Schema.org structured data for the article
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.title,
  "description": post.excerpt,
  "image": absoluteImage,
  "datePublished": post.date,
  "dateModified": post.date,
  "author": {
    "@type": "Person",
    "name": "Christopher Carroll Smith",
    "url": siteURL
  },
  "publisher": {
    "@type": "Person",
    "name": "Christopher Carroll Smith",
    "url": siteURL
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": postURL
  }
};
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  image={pageImage}
  type="article"
  canonicalURL={postURL}
>
  <Fragment slot="head">
    <!-- Article metadata -->
    <meta property="article:published_time" content={post.date} />
    <meta property="article:modified_time" content={post.date} />
    <meta property="article:author" content="Christopher Carroll Smith" />

    <!-- Schema.org structured data -->
    <script is:inline type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  </Fragment>

  <div class="App">
    <HeaderAstro />
    <div class="blog-container">
      <article class="blog-post">
        <h1>{post.title}</h1>
        <div class="post-meta">
          <time datetime={post.date}>{new Date(post.date).toLocaleDateString()}</time>
          <span class="author-byline">By Christopher Carroll Smith</span>
          {post.sourceUrl && (
            <span class="source-attribution">
              Â· Originally published on <a href={post.sourceUrl}>Substack</a>
            </span>
          )}
        </div>
        <p class="post-abstract">{post.excerpt}</p>
        <div set:html={post.content} />
        {post.script && (
          <script is:inline set:html={post.script} />
        )}
      </article>
    </div>
    <Footer client:load />
  </div>

  <script>
    import Prism from 'prismjs';
    import 'prismjs/components/prism-python';

    // Highlight all code blocks
    Prism.highlightAll();
  </script>
</BaseLayout>
