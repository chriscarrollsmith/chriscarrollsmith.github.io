---
import BaseLayout from '../../layouts/BaseLayout.astro';
import HeaderAstro from '../../components/HeaderAstro.astro';
import Footer from '../../components/Footer.tsx';
import blogData from '../../data/blogs.json';
import type { BlogPost } from '../../types/data';
import '../../components/Blog.css';
import sizeOf from 'image-size';
import { readFileSync } from 'fs';
import { join } from 'path';

const typedBlogData = blogData as BlogPost[];

// Normalize image path to always have a single leading slash
const normalizeImagePath = (path: string) => `/${path.replace(/^\/+/, '')}`;

// Sort posts by date, most recent first
const sortedBlogData = [...typedBlogData].sort((a, b) => {
  return new Date(b.date).getTime() - new Date(a.date).getTime();
});

// Calculate aspect ratios and dimensions for images
const postsWithAspectRatio = sortedBlogData.map(post => {
  if (!post.image) return { ...post, aspectRatio: null, width: undefined, height: undefined, isExternalImage: false };

  // Check if image is external URL (e.g., Substack CDN)
  const isExternalImage = post.image.startsWith('http://') || post.image.startsWith('https://');

  if (isExternalImage) {
    // External images: can't calculate dimensions at build time, use default thumbnail behavior
    return { ...post, aspectRatio: 1, width: undefined, height: undefined, isExternalImage: true };
  }

  try {
    // Use process.cwd() to get project root, works correctly during build
    const imagePath = join(process.cwd(), 'public', post.image.replace(/^\/+/, ''));
    const buffer = readFileSync(imagePath);
    const dimensions = sizeOf(buffer);
    const width = dimensions.width ?? undefined;
    const height = dimensions.height ?? undefined;
    const aspectRatio = width && height ? width / height : null;

    return { ...post, aspectRatio, width, height, isExternalImage: false };
  } catch (error) {
    console.error(`Failed to read image dimensions for ${post.image}:`, error);
    return { ...post, aspectRatio: null, width: undefined, height: undefined, isExternalImage: false };
  }
});
---

<BaseLayout
  title="Christopher Carroll Smith | Blog"
  description="Blog posts by Christopher Carroll Smith, software architect, data storyteller, and president of Promptly Technologies, LLC."
  type="website"
>
  <div class="App">
    <HeaderAstro />
    <div class="blog-container">
      <h1>Blog</h1>
      {postsWithAspectRatio.map((post, index) => {
        const isWideBanner = post.aspectRatio && post.aspectRatio > 2;
        const hasImage = post.image && post.aspectRatio;
        const hasThumbnail = hasImage && !isWideBanner;

        // Alternate thumbnail position (even indices = right, odd = left)
        const thumbnailPosition = index % 2 === 0 ? 'right' : 'left';

        return (
          // eslint-disable-next-line react/jsx-key
          <article id={String(post.id)} class={`blog-post-summary ${isWideBanner ? 'blog-post-banner' : ''} ${hasThumbnail ? `thumbnail-${thumbnailPosition}` : ''}`}>
            {hasImage && isWideBanner && (
              <a href={`/blog/${post.id}`} class="blog-banner-link">
                <img
                  src={post.isExternalImage ? post.image : normalizeImagePath(post.image!)}
                  alt={post.title}
                  class="blog-banner"
                  width={post.width}
                  height={post.height}
                  loading="lazy"
                  decoding="async"
                />
              </a>
            )}
            <div class="blog-post-content">
              {hasThumbnail && thumbnailPosition === 'left' && (
                <a href={`/blog/${post.id}`} class="blog-thumbnail-link">
                  <img
                    src={post.isExternalImage ? post.image : normalizeImagePath(post.image!)}
                    alt={post.title}
                    class="blog-thumbnail"
                    width={post.width}
                    height={post.height}
                    loading="lazy"
                    decoding="async"
                  />
                </a>
              )}
              <div class="blog-post-text">
                <h2>
                  <a href={`/blog/${post.id}`}>{post.title}</a>
                </h2>
                <div class="post-meta">
                  <time datetime={post.date}>{new Date(post.date).toLocaleDateString()}</time>
                  <span class="author-byline">By Christopher Carroll Smith</span>
                </div>
                <p>{post.excerpt}</p>
              </div>
              {hasThumbnail && thumbnailPosition === 'right' && (
                <a href={`/blog/${post.id}`} class="blog-thumbnail-link">
                  <img
                    src={post.isExternalImage ? post.image : normalizeImagePath(post.image!)}
                    alt={post.title}
                    class="blog-thumbnail"
                    width={post.width}
                    height={post.height}
                    loading="lazy"
                    decoding="async"
                  />
                </a>
              )}
            </div>
          </article>
        );
      })}
    </div>
    <Footer client:load />
  </div>
</BaseLayout>
