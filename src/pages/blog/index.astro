---
import BaseLayout from '../../layouts/BaseLayout.astro';
import HeaderAstro from '../../components/HeaderAstro.astro';
import Footer from '../../components/Footer.tsx';
import { getCollection } from 'astro:content';
import '../../components/Blog.css';
import sizeOf from 'image-size';
import { readFileSync } from 'fs';
import { join } from 'path';

// Normalize image path to always have a single leading slash
const normalizeImagePath = (path: string) => `/${path.replace(/^\/+/, '')}`;

const blogPosts = await getCollection('blog');

// Sort posts by date, most recent first
const sortedBlogData = [...blogPosts].sort((a, b) => {
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

// Calculate aspect ratios and dimensions for images
const postsWithAspectRatio = sortedBlogData.map(post => {
  const image = post.data.image;
  if (!image) return { post, aspectRatio: null, width: undefined, height: undefined, isExternalImage: false, image: undefined };

  // Check if image is external URL (e.g., Substack CDN)
  const isExternalImage = image.startsWith('http://') || image.startsWith('https://');

  if (isExternalImage) {
    // External images: can't calculate dimensions at build time, use default thumbnail behavior
    return { post, aspectRatio: 1, width: undefined, height: undefined, isExternalImage: true, image };
  }

  try {
    // Use process.cwd() to get project root, works correctly during build
    const imagePath = join(process.cwd(), 'public', image.replace(/^\/+/, ''));
    const buffer = readFileSync(imagePath);
    const dimensions = sizeOf(buffer);
    const width = dimensions.width ?? undefined;
    const height = dimensions.height ?? undefined;
    const aspectRatio = width && height ? width / height : null;

    return { post, aspectRatio, width, height, isExternalImage: false, image };
  } catch (error) {
    console.error(`Failed to read image dimensions for ${image}:`, error);
    return { post, aspectRatio: null, width: undefined, height: undefined, isExternalImage: false, image };
  }
});
---

<BaseLayout
  title="Christopher Carroll Smith | Blog"
  description="Blog posts by Christopher Carroll Smith, software architect, data storyteller, and president of Promptly Technologies, LLC."
  type="website"
>
  <div class="App">
    <HeaderAstro />
    <div class="blog-container">
      <h1>Blog</h1>
      {postsWithAspectRatio.map((item, index) => {
        const { post } = item;
        const isWideBanner = item.aspectRatio && item.aspectRatio > 2;
        const hasImage = item.image && item.aspectRatio;
        const hasThumbnail = hasImage && !isWideBanner;

        // Alternate thumbnail position (even indices = right, odd = left)
        const thumbnailPosition = index % 2 === 0 ? 'right' : 'left';

        return (
          // eslint-disable-next-line react/jsx-key
          <article id={post.slug} class={`blog-post-summary ${isWideBanner ? 'blog-post-banner' : ''} ${hasThumbnail ? `thumbnail-${thumbnailPosition}` : ''}`}>
            {hasImage && isWideBanner && (
              <a href={`/blog/${post.slug}`} class="blog-banner-link">
                <img
                  src={item.isExternalImage ? item.image : normalizeImagePath(item.image!)}
                  alt={post.data.title}
                  class="blog-banner"
                  width={item.width}
                  height={item.height}
                  loading="lazy"
                  decoding="async"
                />
              </a>
            )}
            <div class="blog-post-content">
              {hasThumbnail && thumbnailPosition === 'left' && (
                <a href={`/blog/${post.slug}`} class="blog-thumbnail-link">
                  <img
                    src={item.isExternalImage ? item.image : normalizeImagePath(item.image!)}
                    alt={post.data.title}
                    class="blog-thumbnail"
                    width={item.width}
                    height={item.height}
                    loading="lazy"
                    decoding="async"
                  />
                </a>
              )}
              <div class="blog-post-text">
                <h2>
                  <a href={`/blog/${post.slug}`}>{post.data.title}</a>
                </h2>
                <div class="post-meta">
                  <time datetime={post.data.date}>{new Date(post.data.date).toLocaleDateString()}</time>
                  <span class="author-byline">By Christopher Carroll Smith</span>
                </div>
                <p>{post.data.excerpt}</p>
              </div>
              {hasThumbnail && thumbnailPosition === 'right' && (
                <a href={`/blog/${post.slug}`} class="blog-thumbnail-link">
                  <img
                    src={item.isExternalImage ? item.image : normalizeImagePath(item.image!)}
                    alt={post.data.title}
                    class="blog-thumbnail"
                    width={item.width}
                    height={item.height}
                    loading="lazy"
                    decoding="async"
                  />
                </a>
              )}
            </div>
          </article>
        );
      })}
    </div>
    <Footer client:load />
  </div>
</BaseLayout>
