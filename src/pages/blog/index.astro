---
import BaseLayout from '../../layouts/BaseLayout.astro';
import HeaderAstro from '../../components/HeaderAstro.astro';
import Footer from '../../components/Footer.tsx';
import blogData from '../../data/blogs.json';
import type { BlogPost } from '../../types/data';
import '../../components/Blog.css';
import sizeOf from 'image-size';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const typedBlogData = blogData as BlogPost[];

// Sort posts by date, most recent first
const sortedBlogData = [...typedBlogData].sort((a, b) => {
  return new Date(b.date).getTime() - new Date(a.date).getTime();
});

// Calculate aspect ratios for images
const postsWithAspectRatio = sortedBlogData.map(post => {
  if (!post.image) return { ...post, aspectRatio: null };

  try {
    const imagePath = join(__dirname, '../../../public', post.image);
    const buffer = readFileSync(imagePath);
    const dimensions = sizeOf(buffer);
    const aspectRatio = dimensions.width && dimensions.height
      ? dimensions.width / dimensions.height
      : null;
    return { ...post, aspectRatio };
  } catch (error) {
    console.error(`Failed to read image dimensions for ${post.image}:`, error);
    return { ...post, aspectRatio: null };
  }
});
---

<BaseLayout
  title="Christopher Carroll Smith | Blog"
  description="Blog posts by Christopher Carroll Smith, software architect, data storyteller, and president of Promptly Technologies, LLC."
  type="website"
>
  <div class="App">
    <HeaderAstro />
    <div class="blog-container">
      <h1>Blog</h1>
      {postsWithAspectRatio.map((post, index) => {
        const isWideBanner = post.aspectRatio && post.aspectRatio > 2;
        const hasImage = post.image && post.aspectRatio;
        const hasThumbnail = hasImage && !isWideBanner;

        // Alternate thumbnail position (even indices = right, odd = left)
        const thumbnailPosition = index % 2 === 0 ? 'right' : 'left';

        return (
          <article id={String(post.id)} key={post.id} class={`blog-post-summary ${isWideBanner ? 'blog-post-banner' : ''} ${hasThumbnail ? `thumbnail-${thumbnailPosition}` : ''}`}>
            {hasImage && isWideBanner && (
              <a href={`/blog/${post.id}`} class="blog-banner-link">
                <img src={`/${post.image}`} alt={post.title} class="blog-banner" />
              </a>
            )}
            <div class="blog-post-content">
              {hasThumbnail && thumbnailPosition === 'left' && (
                <a href={`/blog/${post.id}`} class="blog-thumbnail-link">
                  <img src={`/${post.image}`} alt={post.title} class="blog-thumbnail" />
                </a>
              )}
              <div class="blog-post-text">
                <h2>
                  <a href={`/blog/${post.id}`}>{post.title}</a>
                </h2>
                <div class="post-meta">
                  <time datetime={post.date}>{new Date(post.date).toLocaleDateString()}</time>
                  <span class="author-byline">By Christopher Carroll Smith</span>
                </div>
                <p>{post.excerpt}</p>
              </div>
              {hasThumbnail && thumbnailPosition === 'right' && (
                <a href={`/blog/${post.id}`} class="blog-thumbnail-link">
                  <img src={`/${post.image}`} alt={post.title} class="blog-thumbnail" />
                </a>
              )}
            </div>
          </article>
        );
      })}
    </div>
    <Footer client:load />
  </div>
</BaseLayout>
